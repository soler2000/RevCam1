<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RevCam1 WiFi</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#111;color:#eee;margin:0}
    header{display:flex;gap:12px;align-items:center;padding:10px 12px;background:#1b1b1b;position:sticky;top:0}
    header a{color:#9cf;text-decoration:none}
    main{max-width:800px;margin:16px auto;padding:0 12px 24px;display:flex;flex-direction:column;gap:16px}
    section{background:#171717;border:1px solid #333;border-radius:8px;padding:12px}
    button,input,select{background:#222;color:#fff;border:1px solid #444;border-radius:6px;padding:8px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #333;padding:8px;text-align:left}
    .pill{font:12px;border:1px solid #444;border-radius:999px;padding:2px 8px;background:#222}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font:12px/1.3 monospace;white-space:pre-wrap}
    .hint{color:#9cf}
    .err{color:#f99}
    .ok{color:#9f9}
  </style>
</head>
<body>
  <header>
    <strong>RevCam1</strong>
    <a href="/">Viewer</a>
    <a href="/settings">Settings</a>
    <span class="pill">WiFi</span>
  </header>
  <main>
    <section>
      <h3>Status</h3>
      <div id="st">Loading…</div>
      <div class="row">
        <button id="refresh">Refresh</button>
      </div>
    </section>

    <section>
      <h3>Hotspot</h3>
      <div class="row">
        <input id="ap-ssid" placeholder="AP SSID" value="RevCam"/>
        <button id="start-ap-detached">Start Hotspot (detached)</button>
        <button id="stop-ap">Stop Hotspot</button>
      </div>
      <p class="hint">
        After you click <b>Start Hotspot</b>, this page will likely disconnect.<br/>
        Join Wi-Fi network <b>RevCam</b>, then open <b>http://10.42.0.1:8080/wifi</b> to see the result below.
      </p>
      <h4>Hotspot Result</h4>
      <pre id="ap-res" class="mono"></pre>
    </section>

    <section>
      <h3>Available Networks</h3>
      <div class="row">
        <button id="scan">Scan</button>
      </div>
      <table id="tbl">
        <thead><tr><th>SSID</th><th>Security</th><th>Signal</th><th>Connect</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    const $ = (s, p=document)=>p.querySelector(s);
    const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));

    async function getJSON(url, opts) {
      const r = await fetch(url, opts);
      const t = await r.text();
      try { return JSON.parse(t); } catch { return { ok:false, raw:t }; }
    }

    async function refreshStatus() {
      const s = await getJSON('/api/wifi/status');
      const el = $("#st");
      if (!s || s.nmcli === false) { el.innerHTML = '<span class="err">NetworkManager (nmcli) not available.</span>'; return; }
      const rows = [];
      rows.push(`Mode: ${s.mode || '-'}`);
      rows.push(`Connected: ${s.connected ? 'yes' : 'no'}`);
      rows.push(`Hotspot: ${s.ap_running ? 'yes' : 'no'}`);
      rows.push(`SSID: ${s.ssid || '-'}`);
      rows.push(`IP: ${s.ip || '-'}`);
      el.innerHTML = rows.map(r=>`<div>${r}</div>`).join('');
    }

    function rowHTML(n) {
      const needsPass = !!n.needs_password;
      const id = 'pw-' + btoa(unescape(encodeURIComponent(n.ssid))).replace(/=/g,'');
      return `<tr>
        <td>${n.inuse === '*' ? '★ ' : ''}${n.ssid}</td>
        <td>${n.security || '--'}</td>
        <td>${n.signal}</td>
        <td class="row">
          ${needsPass ? `<input id="${id}" placeholder="password" type="password" style="min-width:140px">` : ''}
          <button data-ssid="${encodeURIComponent(n.ssid)}" data-pwid="${needsPass ? id : ''}" class="btn-connect">Connect</button>
        </td>
      </tr>`;
    }

    async function loadScan() {
      $("#tbl tbody").innerHTML = '<tr><td colspan="4">Scanning…</td></tr>';
      const r = await getJSON('/api/wifi/scan');
      if (!r.ok) { $("#tbl tbody").innerHTML = `<tr><td colspan="4" class="err">Scan failed</td></tr>`; return; }
      $("#tbl tbody").innerHTML = r.networks.map(rowHTML).join('') || '<tr><td colspan="4">No networks found</td></tr>';
      $$(".btn-connect").forEach(btn=>{
        btn.onclick = async () => {
          const ssid = decodeURIComponent(btn.dataset.ssid);
          const pwid = btn.dataset.pwid;
          const pwd = pwid ? $("#"+pwid).value : undefined;
          const res = await getJSON('/api/wifi/connect', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ssid, password: pwd }) });
          alert('Connect: ' + JSON.stringify(res));
          await refreshStatus();
        };
      });
    }

    async function pollApStateOnce() {
      const s = await getJSON('/api/wifi/ap_state');
      $("#ap-res").textContent = JSON.stringify(s, null, 2);
      return s?.status || 'idle';
    }

    async function pollApStateUntilDone() {
      let tries = 0;
      let status = await pollApStateOnce();
      while (tries < 40 && (status === 'starting' || status === 'idle')) {
        await new Promise(r=>setTimeout(r, 500));
        status = await pollApStateOnce();
        tries++;
      }
    }

    $("#refresh").onclick = refreshStatus;
    $("#scan").onclick = loadScan;

    $("#start-ap-detached").onclick = async () => {
      const ssid = $("#ap-ssid").value || "RevCam";
      const r = await getJSON('/api/wifi/start_ap_detached', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ssid }) });
      $("#ap-res").textContent = JSON.stringify(r, null, 2);
      // Begin polling immediately; if you lose this page, reconnect to 10.42.0.1 and it will continue there.
      pollApStateUntilDone();
    };

    $("#stop-ap").onclick = async () => {
      const r = await getJSON('/api/wifi/stop_ap', { method:'POST' });
      alert('Stop AP: ' + JSON.stringify(r));
      await refreshStatus();
      await pollApStateOnce();
    };

    // initial
    (async () => { await refreshStatus(); await loadScan(); await pollApStateOnce(); })();
  </script>
</body>
</html>
